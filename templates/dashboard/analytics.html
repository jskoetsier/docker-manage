{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.0.0/dist/chart.min.css" rel="stylesheet">
<style>
    .analytics-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .trend-indicator {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .trend-increasing {
        background-color: #e74c3c;
        color: white;
    }
    
    .trend-decreasing {
        background-color: #27ae60;
        color: white;
    }
    
    .trend-stable {
        background-color: #f39c12;
        color: white;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .time-range-selector {
        margin-bottom: 20px;
    }
    
    .alert-item {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border-left: 4px solid;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffc107;
        color: #856404;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
    }
    
    .service-health-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .service-card {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .performance-score {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        margin: 10px auto;
    }
    
    .score-excellent { background-color: #27ae60; }
    .score-good { background-color: #f39c12; }
    .score-poor { background-color: #e74c3c; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-graph-up"></i> Analytics Dashboard</h1>
                <div class="time-range-selector">
                    <select class="form-select" id="timeRangeSelect">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h" selected>Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Usage Overview -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h3><i class="bi bi-cpu"></i> Resource Usage Trends</h3>
                
                {% if resource_trends.trends %}
                <div class="row">
                    {% for resource, trend in resource_trends.trends.items %}
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="metric-label">{{ resource|title }}</div>
                            <div class="metric-value">{{ trend.current|floatformat:1 }}</div>
                            <span class="trend-indicator trend-{{ trend.trend }}">
                                {% if trend.trend == 'increasing' %}
                                    <i class="bi bi-arrow-up"></i> {{ trend.trend|title }}
                                {% elif trend.trend == 'decreasing' %}
                                    <i class="bi bi-arrow-down"></i> {{ trend.trend|title }}
                                {% else %}
                                    <i class="bi bi-dash"></i> {{ trend.trend|title }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="chart-container">
                    <canvas id="resourceTrendsChart"></canvas>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No resource trend data available yet. 
                    Metrics will appear once the system starts collecting data.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Service Performance Analysis -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h3><i class="bi bi-diagram-3"></i> Service Performance Analysis</h3>
                
                {% if service_analysis.summary %}
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="metric-label">Total Services</div>
                            <div class="metric-value">{{ service_analysis.summary.total_services }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="metric-label">Healthy Services</div>
                            <div class="metric-value text-success">{{ service_analysis.summary.healthy_services }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="metric-label">Health Percentage</div>
                            <div class="metric-value">{{ service_analysis.summary.health_percentage|floatformat:1 }}%</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if service_analysis.analysis %}
                <div class="service-health-grid">
                    {% for service_id, analysis in service_analysis.analysis.items %}
                    <div class="service-card">
                        <h6>{{ service_id|truncatechars:20 }}</h6>
                        
                        <div class="performance-score {% if analysis.stats.performance_score >= 80 %}score-excellent{% elif analysis.stats.performance_score >= 60 %}score-good{% else %}score-poor{% endif %}">
                            {{ analysis.stats.performance_score|floatformat:0 }}
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <small>Uptime</small><br>
                                <strong>{{ analysis.stats.uptime_percentage|floatformat:1 }}%</strong>
                            </div>
                            <div class="col-6">
                                <small>Avg Replicas</small><br>
                                <strong>{{ analysis.stats.avg_replicas|floatformat:1 }}</strong>
                            </div>
                        </div>
                        
                        {% if analysis.alerts %}
                        <div class="mt-2">
                            {% for alert in analysis.alerts %}
                            <div class="alert-item alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> {{ alert }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No service performance data available yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- System Alerts -->
    {% if resource_trends.summary.alerts %}
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h3><i class="bi bi-exclamation-triangle"></i> System Alerts</h3>
                
                {% for alert in resource_trends.summary.alerts %}
                <div class="alert-item alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> {{ alert }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h3><i class="bi bi-lightning"></i> Quick Actions</h3>
                
                <div class="row">
                    <div class="col-md-3">
                        <a href="{% url 'dashboard:historical_metrics' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-graph-up"></i><br>
                            Historical Metrics
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'dashboard:predictive_analytics' %}" class="btn btn-outline-info w-100">
                            <i class="bi bi-crystal-ball"></i><br>
                            Predictive Analytics
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'dashboard:custom_dashboards' %}" class="btn btn-outline-success w-100">
                            <i class="bi bi-layout-text-window"></i><br>
                            Custom Dashboards
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="exportData()">
                            <i class="bi bi-download"></i><br>
                            Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.0/dist/chart.min.js"></script>
<script>
let resourceTrendsChart = null;

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeResourceTrendsChart();
});

// Time range selector
document.getElementById('timeRangeSelect').addEventListener('change', function() {
    const selectedRange = this.value;
    window.location.href = `?range=${selectedRange}`;
});

function initializeResourceTrendsChart() {
    const ctx = document.getElementById('resourceTrendsChart');
    if (!ctx) return;

    {% if resource_trends.data %}
    const resourceData = {{ resource_trends.data|safe }};
    
    const datasets = [];
    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12'];
    let colorIndex = 0;
    
    for (const [resource, data] of Object.entries(resourceData)) {
        if (data && data.length > 0) {
            datasets.push({
                label: resource.charAt(0).toUpperCase() + resource.slice(1),
                data: data.map(point => ({
                    x: point.timestamp,
                    y: point.value
                })),
                borderColor: colors[colorIndex % colors.length],
                backgroundColor: colors[colorIndex % colors.length] + '20',
                fill: false,
                tension: 0.1
            });
            colorIndex++;
        }
    }
    
    if (datasets.length > 0) {
        resourceTrendsChart = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }
    {% endif %}
}

function exportData() {
    // Implement data export functionality
    const exportData = {
        measurements: ['system_resources', 'service_replicas', 'service_health'],
        time_range: document.getElementById('timeRangeSelect').value,
        format: 'json'
    };
    
    fetch('{% url "dashboard:api_export_data" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(exportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create download link
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            alert('Export failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Export failed');
    });
}

// Auto-refresh data every 30 seconds
setInterval(function() {
    if (resourceTrendsChart) {
        // Refresh chart data
        location.reload();
    }
}, 30000);
</script>
{% endblock %}